(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{329:function(e,t,n){"use strict";n.r(t);n(198),n(13),n(40),n(69),n(37);var o=n(331),c=n(144),r=n(145),l=(n(85),n(53),n(84),n(297),n(302),n(304),n(305),n(306),n(307),n(308),n(309),n(310),n(311),n(312),n(313),n(314),n(315),n(316),n(317),n(319),n(320),n(321),n(322),n(323),n(324),n(325),n(326),n(327),n(328),n(288),function(){function e(){Object(c.a)(this,e),this.messageIdentifiers={BATTERY_LEVEL:3,DICE_COLOUR:23,SET_LED:8,DICE_VALUE:9,SET_LED_TOGGLE:16},this.diceColour={BLACK:0,RED:1,GREEN:2,BLUE:3,YELLOW:4,ORANGE:5},this.bluetoothDevice=void 0,this.GoDiceService=void 0,this.CubeCharacteristics=void 0,this.GlobalDeviceId=void 0,this.diceId=void 0,this.rolledValue=0,this.dieType=e.diceTypes.D6,this.handleNotificationChanged=this.onNotificationChanged.bind(this)}return Object(r.a)(e,[{key:"onRollStart",value:function(){}},{key:"onBatteryLevel",value:function(){}},{key:"onDiceColor",value:function(){}},{key:"onStable",value:function(){}},{key:"onFakeStable",value:function(){}},{key:"onTiltStable",value:function(){}},{key:"onMoveStable",value:function(){}},{key:"onDiceConnected",value:function(){}},{key:"getBatteryLevel",value:function(){console.debug("getBatteryLevel",this),this.sendMessage([this.messageIdentifiers.BATTERY_LEVEL])}},{key:"getDiceColor",value:function(){console.debug("getDiceColor",this),this.sendMessage([this.messageIdentifiers.DICE_COLOUR])}},{key:"getDiceValue",value:function(){console.debug("getDiceValue",this),this.sendMessage([this.messageIdentifiers.DICE_VALUE])}},{key:"setDieType",value:function(e){this.dieType=e}},{key:"requestDevice",value:function(){var e=this;return navigator.bluetooth.requestDevice({filters:[{namePrefix:"GoDice_"}],optionalServices:["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]}).then((function(t){console.debug("requestDevice:device",t),e.GlobalDeviceId=t.id.toString(),e.bluetoothDevice=t,e.bluetoothDevice.addEventListener("gattserverdisconnected",e.onDisconnected),e.connectDeviceAndCacheCharacteristics()}))}},{key:"setLed",value:function(e,t){console.debug(e,t);var n=e||[0,0,0],c=t||[0,0,0];n=n.map((function(i){return Math.max(Math.min(i,255),0)})),c=c.map((function(i){return Math.max(Math.min(i,255),0)})),1===n.length&&n.push(n[0],n[0]),1===c.length&&c.push(c[0],c[0]);var r=[this.messageIdentifiers.SET_LED].concat(Object(o.a)(n),Object(o.a)(c));console.debug("messageArray",r),this.sendMessage(r)}},{key:"pulseLed",value:function(e,t,n,c){if(3===c.length){var r=c.map((function(i){return Math.max(Math.min(i,255),0)})),l=[this.messageIdentifiers.SET_LED_TOGGLE,e,t,n].concat(Object(o.a)(r),[1,0]);this.sendMessage(l)}}},{key:"sendMessage",value:function(e){return this.GoDiceService?this.GoDiceService.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e").then((function(t){console.debug("messageArray",e);var n=new Uint8Array(e);return t.writeValue(n).then((function(e){console.debug("after write response",e)}))})):Promise.reject(new Error("No Cube characteristic selected yet."))}},{key:"getClosestVector",value:function(e,t){var n=t[0],o=t[1],c=t[2],r=Number.MAX_SAFE_INTEGER,l=0,d=[],h=0,v=0,f=0,y=0;for(var D in e)h=n-(d=e[D])[0],v=o-d[1],f=c-d[2],(y=Math.pow(h,2)+Math.pow(v,2)+Math.pow(f,2))<r&&(r=y,l=D);return l}},{key:"getXyzFromBytes",value:function(data,e){return[data.getInt8(e),data.getInt8(e+1),data.getInt8(e+2)]}},{key:"getDieValue",value:function(data,t){var n=this.getXyzFromBytes(data,t),o=0;if(this.dieType===e.diceTypes.D6)o=this.getClosestVector(e.d6Vectors,n);else if(this.dieType>=e.diceTypes.D20&&this.dieType<=e.diceTypes.D10X)switch(o=this.getClosestVector(e.d20Vectors,n),this.dieType){case e.diceTypes.D10:o=e.d10Transform[o];break;case e.diceTypes.D10X:o=e.d10XTransform[o]}else if(this.dieType>=e.diceTypes.D4&&this.dieType<=e.diceTypes.D12)switch(o=this.getClosestVector(e.d24Vectors,n),this.dieType){case e.diceTypes.D4:o=e.d4Transform[o];break;case e.diceTypes.D8:o=e.d8Transform[o];break;case e.diceTypes.D12:o=e.d12Transform[o]}return o}},{key:"getD20Value",value:function(data,e){var t=this.getXyzFromBytes(data,e);return this.getClosestVector(this.d20Vectors,t)}},{key:"getD24Value",value:function(data,e){var t=this.getXyzFromBytes(data,e);return this.getClosestVector(this.d24Vectors,t)}},{key:"parseMessage",value:function(data,e){try{console.debug("parseMessage"),console.debug("data: ",data),console.debug("deviceId: ",e);var t=data.getUint8(0);if(82===t)return void this.onRollStart(e);var n=data.getUint8(1),o=data.getUint8(2);if(66===t&&97===n&&116===o&&this.onBatteryLevel(e,data.getUint8(3)),67===t&&111===n&&108===o&&this.onDiceColor(e,data.getUint8(3)),83===t){var c=this.getDieValue(data,1),r=this.getXyzFromBytes(data,1);this.rolledValue=c,this.onStable(e,c,r)}if(70===t&&83===n){var l=this.getDieValue(data,2),d=this.getXyzFromBytes(data,2);this.rolledValue=l,this.onFakeStable(e,l,d)}if(84===t&&83===n){var h=this.getDieValue(data,2),v=this.getXyzFromBytes(data,2);this.rolledValue=h,this.onTiltStable(e,v,h)}if(77===t&&83===n){var f=this.getDieValue(data,2),y=this.getXyzFromBytes(data,2);this.rolledValue=f,this.onMoveStable(e,f,y)}}catch(e){console.error("err",e)}}},{key:"onNotificationChanged",value:function(e){console.debug("onNotificationChanged",e.target.service.device.id.toString()),this.parseMessage(e.target.value,e.target.service.device.id.toString())}},{key:"connectDeviceAndCacheCharacteristics",value:function(){var e=this;return console.debug("Connecting to GATT Server..."),this.bluetoothDevice.gatt.connect().then((function(e){return e.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e")})).then((function(t){return e.GoDiceService=t,t.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e")})).then((function(t){return e.CubeCharacteristics=t,e.CubeCharacteristics.addEventListener("characteristicvaluechanged",e.handleNotificationChanged),t.getDescriptors()})).then((function(t){e.onStartNotificationsButtonClick()}))}},{key:"onStartNotificationsButtonClick",value:function(){var e=this;console.debug("Starting Notifications..."),this.CubeCharacteristics.startNotifications().then((function(){console.debug("onDiceConnected"),e.onDiceConnected(e.GlobalDeviceId,e)})).catch((function(e){console.error("Argh! "+e)}))}},{key:"onDisconnectButtonClick",value:function(){this.CubeCharacteristics&&(this.CubeCharacteristics.removeEventListener("characteristicvaluechanged",this.handleNotificationChanged),this.CubeCharacteristics=null),null!==this.bluetoothDevice&&(this.bluetoothDevice.gatt.connected?this.bluetoothDevice.gatt.disconnect():console.debug("> Bluetooth Device is already disconnected"),this.bluetoothDevice=null)}},{key:"onDisconnected",value:function(e){console.debug("> Bluetooth Device disconnected:"+e)}}]),e}());l.diceTypes={D6:0,D20:1,D10:2,D10X:3,D4:4,D8:5,D12:6},l.d6Vectors={1:[-64,0,0],2:[0,0,64],3:[0,64,0],4:[0,-64,0],5:[0,0,-64],6:[64,0,0]},l.d20Vectors={1:[-64,0,-22],2:[42,-42,40],3:[0,22,-64],4:[0,22,64],5:[-42,-42,42],6:[22,64,0],7:[-42,-42,-42],8:[64,0,-22],9:[-22,64,0],10:[42,-42,-42],11:[-42,42,42],12:[22,-64,0],13:[-64,0,22],14:[42,42,42],15:[-22,-64,0],16:[42,42,-42],17:[0,-22,-64],18:[0,-22,64],19:[-42,42,-42],20:[64,0,22]},l.d24Vectors={1:[20,-60,-20],2:[20,0,60],3:[-40,-40,40],4:[-60,0,20],5:[40,20,40],6:[-20,-60,-20],7:[20,60,20],8:[-40,20,-40],9:[-40,40,40],10:[-20,0,60],11:[-20,-60,20],12:[60,0,20],13:[-60,0,-20],14:[20,60,-20],15:[20,0,-60],16:[40,-20,-40],17:[-20,60,-20],18:[-40,-40,-40],19:[40,-20,40],20:[20,-60,20],21:[60,0,-20],22:[40,20,-40],23:[-20,0,-60],24:[-20,60,20]},l.d10Transform={1:8,2:2,3:6,4:1,5:4,6:3,7:9,8:0,9:7,10:5,11:5,12:7,13:0,14:9,15:3,16:4,17:1,18:6,19:2,20:8},l.d10XTransform={1:80,2:20,3:60,4:10,5:40,6:30,7:90,8:0,9:70,10:50,11:50,12:70,13:0,14:90,15:30,16:40,17:10,18:60,19:20,20:80},l.d4Transform={1:3,2:1,3:4,4:1,5:4,6:4,7:1,8:4,9:2,10:3,11:1,12:1,13:1,14:4,15:2,16:3,17:3,18:2,19:2,20:2,21:4,22:1,23:3,24:2},l.d8Transform={1:3,2:3,3:6,4:1,5:2,6:8,7:1,8:1,9:4,10:7,11:5,12:5,13:4,14:4,15:2,16:5,17:7,18:7,19:8,20:2,21:8,22:3,23:6,24:6},l.d12Transform={1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:1,14:2,15:3,16:4,17:5,18:6,19:7,20:8,21:9,22:10,23:11,24:12};var d={name:"ConnectDice",props:{value:{type:Object,default:function(){return{}}}},data:function(){return{dice:{},connectedDice:{},state:"idle",checkBatteryInterval:null}},watch:{state:function(e){"connected"===e&&(this.$set(this.connectedDice,this.dice.id,this.dice),this.dice.instance.getDiceColor()),"color set"===e&&this.dice.instance.getBatteryLevel(),"battery level set"===e&&this.dice.instance.getDiceValue(),"dice value set"===e&&(this.$emit("input",this.connectedDice),this.dice.instance.pulseLed(5,30,20,[0,0,255]),this.dice={},this.state="idle")}},created:function(){var e=this;this.checkBatteryStatus(),l.prototype.onDiceConnected=function(t,n){e.dice={id:t,instance:n,color:"black",batteryLevel:0,rollling:!1,value:0,invalidMove:!1},e.state="connected"},l.prototype.onDiceColor=function(t,n){var o=e.dice.instance.diceColour,c=Object.keys(o).find((function(e){return o[e]===n}));e.updateDiceProp(t,"color",c.toLowerCase()),e.state="color set"},l.prototype.onBatteryLevel=function(t,n){"color set"===e.state&&(e.state="battery level set"),e.updateDiceProp(t,"batteryLevel",n)},l.prototype.onRollStart=function(t){e.updateDiceProp(t,"invalidMove",!1),e.updateDiceProp(t,"rollling",!0)},l.prototype.onStable=function(t,n,o){"battery level set"===e.state&&(e.state="dice value set"),e.updateDiceProp(t,"invalidMove",!1),e.updateDiceProp(t,"rollling",!1),e.updateDiceProp(t,"value",parseInt(n))},l.prototype.onMoveStable=function(t,n){e.updateDiceProp(t,"invalidMove",!0),e.updateDiceProp(t,"rollling",!1),e.updateDiceProp(t,"value",parseInt(n))},l.prototype.onFakeStable=function(t,n){e.updateDiceProp(t,"invalidMove",!0),e.updateDiceProp(t,"rollling",!1),e.updateDiceProp(t,"value",parseInt(n))}},methods:{connect:function(){var e=new l;this.state="connecting",e.requestDevice()},checkBatteryStatus:function(){var e=this;0!==Object.keys(this.connectedDice)?this.checkBatteryInterval=setInterval((function(){Object.keys(e.connectedDice).forEach((function(t){e.connectedDice[t].instance.getBatteryLevel()}))}),6e4):clearInterval(this.checkBatteryInterval)},updateDiceProp:function(e,t,n){this.$set(this.connectedDice[e],t,n)}}},h=n(54),component=Object(h.a)(d,(function(){var e=this;return(0,e._self._c)("button",{staticClass:"border-2 border-black px-4 py-2 rounded-full",on:{click:e.connect}},[e._v("\n  Connect GoDice\n")])}),[],!1,null,null,null);t.default=component.exports}}]);